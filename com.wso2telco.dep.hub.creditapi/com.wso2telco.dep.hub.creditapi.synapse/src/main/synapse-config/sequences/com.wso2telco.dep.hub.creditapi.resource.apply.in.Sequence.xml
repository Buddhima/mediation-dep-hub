<?xml version="1.0" encoding="UTF-8"?>
<sequence name="com.wso2telco.dep.hub.creditapi.resource.apply.in.Sequence" onError="com.wso2telco.dep.common.response.unexpectedError.Sequence" trace="disable" xmlns="http://ws.apache.org/ns/synapse">

  	<sequence key="com.wso2telco.dep.common.main.request.Sequence"/>
    
    <property expression="$ctx:uri.var.msisdn" name="msisdn" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:msisdn)" name="msisdn" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <property expression="json-eval($.creditApplyRequest.type)" name="type" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:type)" name="type" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <property expression="json-eval($.creditApplyRequest.amount)" name="amount" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:amount)" name="amount" scope="default" type="STRING"  pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <property expression="json-eval($.creditApplyRequest.clientCorrelator)" name="clientCorrelator" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:clientCorrelator)" name="clientCorrelator" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <property expression="json-eval($.creditApplyRequest.referenceCode)" name="referenceCode" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:referenceCode)" name="referenceCode" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <property expression="json-eval($.creditApplyRequest.reasonForCredit)" name="reasonForCredit" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:reasonForCredit)" name="reasonForCredit" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <property expression="json-eval($.creditApplyRequest.merchantIdentification)" name="merchantIdentification" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:merchantIdentification)" name="merchantIdentification" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <property expression="json-eval($.creditApplyRequest.receiptRequest.notifyURL)" name="notifyURL" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:notifyURL)" name="notifyURL" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    	
    <property expression="json-eval($.creditApplyRequest.receiptRequest.callbackData)" name="callbackData" scope="default" type="STRING"/>
    <property expression="fn:normalize-space($ctx:callbackData)" name="callbackData" scope="default" type="STRING" pattern="((^(?!null).*$)|(^(null).+$))" group="1"/>
    
    <log category="DEBUG" level="custom">
        <property expression="$ctx:msisdn" name="msisdn"/>
        <property expression="$ctx:type" name="type"/>
        <property expression="$ctx:amount" name="amount"/>
        <property expression="$ctx:clientCorrelator" name="clientCorrelator"/>
        <property expression="$ctx:referenceCode" name="referenceCode"/>
        <property expression="$ctx:reasonForCredit" name="reasonForCredit"/>
        <property expression="$ctx:merchantIdentification" name="merchantIdentification"/>
        <property expression="$ctx:notifyURL" name="notifyURL"/>
        <property expression="$ctx:callbackData" name="callbackData"/>
    </log>
    
    <sequence key="com.wso2telco.dep.hub.creditapi.resource.apply.validator.Sequence"/>
    	
	<!-- Parameter for endpoint retrieval -->
	<property expression="$ctx:msisdn" name="MSISDN" scope="default" type="STRING"/>
	<!-- retrieve operator's endpoint -->
	<sequence key="com.wso2telco.dep.common.endpoint.retriever.Sequence"/>
	
    <filter xpath="boolean($ctx:notifyURL)">
    	<then>
			<property  expression="get-property('registry', 'conf:/repository/wso2telco/configurations/notificationURL.xml')"
			  name="notificationURLConfig" scope="default" type="OM"/>
			<property expression="$ctx:notificationURLConfig//credit" name="NOTIFICATION_URL" scope="default" type="STRING"/>
			<!-- save service provider's notify url and generate new notify url from hub -->
			<sequence key="com.wso2telco.dep.common.notification.url.modify.Sequence"/>
			<filter regex="true" source="get-property('INTERNAL_ERROR')">
			  <then>
			    <sequence key="com.wso2telco.dep.common.response.exceptions.Sequence"/>
			  </then>
			  <else/>
			</filter>    		
    	</then>
    	<else/>
    </filter>	
	
	<!-- retrieve operator's access token -->
	<sequence key="com.wso2telco.dep.common.select.token.Sequence"/>

	<!-- generating request clientCorrelator -->
	<call-template target="com.wso2telco.dep.common.clientCorrelator.generator.Template">
	    <with-param name="clientCorrelator" value="{$ctx:clientCorrelator}"/>
	</call-template>

    <filter regex="true" source="boolean(fn:normalize-space($ctx:uniqueClientCorrelator))">
        <then>
            <call-template target="com.wso2telco.dep.common.jsonEnrich.Template">
                <with-param name="sourceProperty" value="uniqueClientCorrelator"/>
                <with-param name="sourceType" value="property"/>
                <with-param name="targetJsonPath" value="$.creditApplyRequest.clientCorrelator"/>
                <with-param name="targetAction" value="set"/>
            </call-template>
        </then>
        <else/>
    </filter>

    <filter regex="true" source="boolean(fn:normalize-space($ctx:generatedNotifyURL))">
        <then>
            <call-template target="com.wso2telco.dep.common.jsonEnrich.Template">
                <with-param name="sourceProperty" value="generatedNotifyURL"/>
                <with-param name="sourceType" value="property"/>
                <with-param name="targetJsonPath" value="$.creditApplyRequest.receiptRequest.notifyURL"/>
                <with-param name="targetAction" value="set"/>
            </call-template>
        </then>
        <else/>
    </filter>
	
	<sequence key="com.wso2telco.dep.common.call.endpoint.Sequence"/>
	
	<!-- retrieve hub url from registry -->
  	<property expression="get-property('registry', 'conf:/repository/wso2telco/configurations/mediationConfig.xml')" name="mediationConfig" scope="default" type="OM"/>
  	<property expression="$ctx:mediationConfig//huburl" name="hubUrl" scope="default" type="STRING"/>
	
    <!-- setting client correlator -->
    <filter regex="true" source="boolean(fn:normalize-space($ctx:clientCorrelator))">
        <then>
            <call-template target="com.wso2telco.dep.common.jsonEnrich.Template">
                <with-param name="sourceProperty" value="clientCorrelator"/>
                <with-param name="sourceType" value="property"/>
                <with-param name="targetJsonPath" value="$.creditApplyResponse.clientCorrelator"/>
                <with-param name="targetAction" value="set"/>
            </call-template>
        </then>
        <else>
            <call-template target="com.wso2telco.dep.common.jsonDetach.Template">
                <with-param name="jsonPath" value="$.creditApplyResponse.clientCorrelator"/>
            </call-template>
        </else>
    </filter>

    <!-- setting generated notify URL -->
    <filter regex="true" source="boolean(fn:normalize-space($ctx:generatedNotifyURL))">
        <then>
            <call-template target="com.wso2telco.dep.common.jsonEnrich.Template">
                <with-param name="sourceProperty" value="notifyURL"/>
                <with-param name="sourceType" value="property"/>
                <with-param name="targetJsonPath" value="$.creditApplyResponse.receiptResponse.notifyURL"/>
                <with-param name="targetAction" value="set"/>
            </call-template>
        </then>
        <else/>
    </filter>

    <!-- setting resource URL -->
    <filter regex="true" source="boolean(fn:normalize-space($.creditApplyResponse.receiptResponse.resourceURL))">
        <then>
            <property name="replacingValue" expression="fn:concat($ctx:hubUrl, '/', $ctx:API_NAME, '/', $ctx:VERSION)"/>
            <property name="responseResourceURL" expression="json-eval($.creditApplyResponse.receiptResponse.resourceURL)"/>
            <call-template target="com.wso2telco.dep.common.stringReplace.Template">
                <with-param name="searchValue" value="{$ctx:OPERATOR_ENDPOINT}"/>
                <with-param name="newValue" value="{$ctx:replacingValue}"/>
                <with-param name="inputValue" value="{$ctx:responseResourceURL}"/>
                <with-param name="outputProperty" value="hubResourceURL"/>
            </call-template>
            <call-template target="com.wso2telco.dep.common.jsonEnrich.Template">
                <with-param name="sourceProperty" value="hubResourceURL"/>
                <with-param name="sourceType" value="property"/>
                <with-param name="targetJsonPath" value="$.creditApplyResponse.receiptResponse.resourceURL"/>
                <with-param name="targetAction" value="set"/>
            </call-template>
        </then>
        <else>
            <call-template target="com.wso2telco.dep.common.jsonDetach.Template">
                <with-param name="jsonPath" value="$.creditApplyResponse.receiptResponse.resourceURL"/>
            </call-template>
        </else>
    </filter>

	<sequence key="com.wso2telco.dep.common.main.response.Sequence"/>
  
</sequence>
