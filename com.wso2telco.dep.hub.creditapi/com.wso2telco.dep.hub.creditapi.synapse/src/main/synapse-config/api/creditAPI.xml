<?xml version="1.0" encoding="UTF-8"?>
<api context="/credit" name="creditAPI" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="POST" uri-template="/v1/credit/{+msisdn}/apply">
        <inSequence>
            <!-- Response with a validation error -->
            <!-- TODO  identify correct http status codes-->
            <property name="isValid" scope="default" type="BOOLEAN" value="false"/>
            <property name="FORCE_ERROR_ON_SOAP_FAULT" scope="default" type="STRING" value="true"/>
            <property expression="$ctx:uri.var.msisdn" name="msisdn" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.type)" name="type" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.amount)" name="amount" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.clientCorrelator)" name="clientCorrelator" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.referenceCode)" name="referenceCode" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.reasonForCredit)" name="reasonForCredit" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.merchantIdentification)" name="merchantIdentification" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.receiptRequest.notifyURL)" name="notifyURL" scope="default" type="STRING"/>
            <property expression="json-eval($.creditApplyRequest.receiptRequest.callbackData)" name="callbackData" scope="default" type="STRING"/>
            <log category="DEBUG" level="custom">
                <property expression="$ctx:msisdn" name="msisdn"/>
                <property expression="$ctx:type" name="type"/>
                <property expression="$ctx:amount" name="amount"/>
                <property expression="$ctx:clientCorrelator" name="clientCorrelator"/>
                <property expression="$ctx:referenceCode" name="referenceCode"/>
                <property expression="$ctx:reasonForCredit" name="reasonForCredit"/>
                <property expression="$ctx:merchantIdentification" name="merchantIdentification"/>
                <property expression="$ctx:notifyURL" name="notifyURL"/>
                <property expression="$ctx:callbackData" name="callbackData"/>
            </log>
            <filter xpath="boolean($ctx:msisdn) and boolean($ctx:type) and boolean($ctx:amount) and boolean($ctx:referenceCode) and boolean($ctx:merchantIdentification)">
                <then>
                    <switch source="$ctx:type">
                        <case regex="^(money|data|minutes)$">
                            <filter regex="^[0-9]+(\.[0-9]{1,2})?$" source="$ctx:amount">
                                <then>
                                    <property name="isValid" scope="default" type="BOOLEAN" value="true"/>
                                </then>
                                <else/>
                            </filter>
                        </case>
                        <case regex="^sms$">
                            <filter regex="^[0-9]+" source="$ctx:amount">
                                <then>
                                    <property name="isValid" scope="default" type="BOOLEAN" value="true"/>
                                </then>
                                <else/>
                            </filter>
                        </case>
                        <default/>
                    </switch>
                </then>
                <else>
                    <filter xpath="not(boolean($ctx:msisdn))">
                        <then>
                            <property expression="fn:concat('msisdn',',')" name="missingParameters" scope="default" type="STRING"/>
                        </then>
                        <else/>
                    </filter>
                    <filter xpath="not(boolean($ctx:type))">
                        <then>
                            <property expression="fn:concat($ctx:missingParameters, 'type,')" name="missingParameters" scope="default" type="STRING"/>
                        </then>
                        <else/>
                    </filter>
                    <filter xpath="not(boolean($ctx:amount))">
                        <then>
                            <property expression="fn:concat($ctx:missingParameters, 'amount,')" name="missingParameters" scope="default" type="STRING"/>
                        </then>
                        <else/>
                    </filter>
                    <filter xpath="not(boolean($ctx:referenceCode))">
                        <then>
                            <property expression="fn:concat($ctx:missingParameters, 'referenceCode,')" name="missingParameters" scope="default" type="STRING"/>
                        </then>
                        <else/>
                    </filter>
                    <filter xpath="not(boolean($ctx:merchantIdentification))">
                        <then>
                            <property expression="fn:concat($ctx:missingParameters, 'merchantIdentification,')" name="missingParameters" scope="default" type="STRING"/>
                        </then>
                        <else/>
                    </filter>
                    <property expression="fn:substring($ctx:missingParameters, 0, fn:string-length($ctx:missingParameters))" name="missingParameters" scope="default" type="STRING"/>
                </else>
            </filter>
            <log category="DEBUG" level="custom">
                <property expression="$ctx:isValid" name="isValid"/>
            </log>
            <filter regex="^false$" source="$ctx:isValid">
                <then>
                    <property name="httpStatusCode" scope="default" type="STRING" value="400"/>
                    <property name="messageId" scope="default" type="STRING" value="SVC0002"/>
                    <property name="errorText" scope="default" type="STRING" value="Invalid input value for message part %1"/>
                    <property expression="fn:concat('Missing mandatory parameters: ', $ctx:missingParameters)" name="errorVariable" scope="default" type="STRING"/>
                    <sequence key="mediation.common.response.ServiceException.Sequence"/>
                    <log category="WARN" level="full">
                        <property expression="$ctx:missingParameters" name="missingParameters"/>
                    </log>
                </then>
                <else/>
            </filter>
            <drop/>
        </inSequence>
        <outSequence/>
        <faultSequence>
            <property name="httpStatusCode" scope="default" type="STRING" value="500"/>
            <property name="messageId" scope="default" type="STRING" value="POL0299"/>
            <property name="errorText" scope="default" type="STRING" value="Unexpected Error "/>
            <property name="errorVariable" scope="default" type="STRING" value=""/>
            <sequence key="mediation.common.response.ServiceException.Sequence"/>
        </faultSequence>
    </resource>
    <resource methods="POST" uri-template="/v1/credit/{+msisdn}/refund">
        <inSequence>
            <property name="FORCE_ERROR_ON_SOAP_FAULT" scope="default" type="STRING" value="true"/>
            <property expression="$ctx:uri.var.msisdn" name="msisdn" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.originalServerReferenceCode)" name="originalServerReferenceCode" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.refundAmount)" name="refundAmount" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.clientCorrelator)" name="clientCorrelator" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.reasonForRefund)" name="reasonForRefund" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.merchantIdentification)" name="merchantIdentification" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.notifyURL)" name="notifyURL" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.callbackData)" name="callbackData" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.paymentAmount.chargingInformation.amount)" name="amount" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.paymentAmount.chargingInformation.currency)" name="currency" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.paymentAmount.chargingInformation.description)" name="description" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.paymentAmount.changingMetaData.onBehalfOf)" name="onBehalfOf" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.paymentAmount.changingMetaData.purchaseCategoryCode)" name="purchaseCategoryCode" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.paymentAmount.changingMetaData.channel)" name="channel" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.paymentAmount.changingMetaData.taxAmount)" name="taxAmount" scope="default" type="STRING"/>
            <property expression="json-eval($.refundRequest.referenceCode)" name="referenceCode" scope="default" type="STRING"/>
            <log level="custom">
                <property expression="$ctx:msisdn" name="msisdn"/>
            </log>
            <drop/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>
